//---------------------------------------------------------------------------

#include <vcl.h>
#pragma hdrstop

#include "MainThread.h"
#pragma package(smart_init)

#include "MyPISODIO.h""
#include "C_GetTime.h" 
#include "PCIM114.h"
#include "IniFile.h"
#include "math.h"
#include "PISODNM100.h"
#include "DeltaPLC.h"
#include "TA5Serial.h";


#include <algorithm>

extern CMyPISODIO g_DIO;
extern CPCIM114 g_Motion;
extern CIniFile g_IniFile;
extern CPISODNM100 g_DNPort0;
extern CPISODNM100 g_DNPort1;
extern CTA5Serial g_Balance;

bool g_bStopMainThread=false;

CMainThread *g_pMainThread;
//---------------------------------------------------------------------------

//   Important: Methods and properties of objects in VCL can only be
//   used in a method called using Synchronize, for example:
//
//      Synchronize(UpdateCaption);
//
//   where UpdateCaption could look like:
//
//      void __fastcall CMainThread::UpdateCaption()
//      {
//        Form1->Caption = "Updated in a thread";
//      }
//---------------------------------------------------------------------------

__fastcall CMainThread::CMainThread(bool CreateSuspended)
        : TThread(CreateSuspended)
{

        m_bRefresh=false;
        m_bIsHomeDone=false;

}
//---------------------------------------------------------------------------
void __fastcall CMainThread::Execute()
{
        //---- Place thread code here ----
         C_GetTime tmReset,tmAlarm,tmResetLamp;

	g_bStopMainThread=false;

	bool bHomeDone=false;
	bool bAutoMode=false;

	bool bLastStart=false;
	bool bLastReset=false;

	bool bAlarmLamp=false;
	bool bResetLamp=false;

        bool bStartMachineInit=false;

	//int nThreadIndex[MAX_PROCESS]={0};		//0:Inti 1:Start Measure

	while(1)
	{
		if(g_bStopMainThread) break;

                //Status
                m_bIsHomeDone=bHomeDone;
                m_bIsAutoMode=bAutoMode;
                //

                 g_Motion.m_bAutoMode=m_bIsAutoMode;


                //---Start Homing
		if(g_DIO.ReadDIBit(DI::ResetBtn) && !bLastReset) tmReset.timeStart(3000);
		if(bLastReset && tmReset.timeUp())
		{
			bStartMachineInit=true;
			bHomeDone=false;
		}
		bLastReset=g_DIO.ReadDIBit(DI::ResetBtn);

                //CheckAlarm();
		
                //----Alarm Occured
		if(g_IniFile.m_nErrorCode>0 && g_IniFile.m_nErrorCode<1000)
		{
			bStartMachineInit=false;
			bAutoMode=false;

                        m_bStartPressCal[0]=false;
                        m_bStartPressCal[1]=false;
                        m_bStartLaserUpCal[0]=false;
                        m_bStartLaserUpCal[1]=false;
                        m_bStartLaserDownCal[0]=false;
                        m_bStartLaserDownCal[1]=false;
                        m_bStartLamSub[0]=false;
                         m_bStartLamSub[1]=false;

                        g_Motion.Stop(0);
                        g_Motion.Stop(1);
                        g_Motion.Stop(2);
                        g_Motion.Stop(3);
                        g_Motion.Stop(4);
                        g_Motion.Stop(5);
                        g_Motion.Stop(6);
                        g_Motion.Stop(7);

                        g_DIO.SetDO(DO::LCMotorStart,false);
                        g_DIO.SetDO(DO::LamMotorStart1,false);
                        g_DIO.SetDO(DO::LamMotorStart2,false);
                        g_DIO.SetDO(DO::EjectMotorStart1,false);
                        g_DIO.SetDO(DO::EjectMotorStart2,false);

                        SetManualSpeed();
		}

                //---Reset Alarm
		if(g_DIO.ReadDIBit(DI::ResetBtn) )
		{
			g_IniFile.m_nErrorCode=0;

			g_DIO.SetDO(DO::RedLamp,false);
			g_DIO.SetDO(DO::Buzzer,false);
		}

                //---Buzzer
		if(tmAlarm.timeUp() && g_IniFile.m_nErrorCode>0)
		{
			g_DIO.SetDO(DO::RedLamp,bAlarmLamp);
			g_DIO.SetDO(DO::Buzzer,bAlarmLamp);
			bAlarmLamp=!bAlarmLamp;
			tmAlarm.timeStart(500);
		}
		
                //--Stop Auto
		if(g_DIO.ReadDIBit(DI::StopBtn))
                {
                        bAutoMode=false;
                        SetManualSpeed();

                        //g_Motion.Stop(AXIS_FL);
                        //g_Motion.Stop(AXIS_RL);

                        g_DIO.SetDO(DO::LCMotorStart,false);
                        g_DIO.SetDO(DO::LamMotorStart1,false);
                        g_DIO.SetDO(DO::LamMotorStart2,false);
                        g_DIO.SetDO(DO::EjectMotorStart1,false);
                        g_DIO.SetDO(DO::EjectMotorStart2,false);

                }

	        //---Homing Process
		if(!bHomeDone && !bAutoMode  && bStartMachineInit)
		{
			bHomeDone=InitialMachine(nThreadIndex[0]);
			if(bHomeDone)
                        {
                                nThreadIndex[1]=0;

                                bStartMachineInit=false;
                        }

                        CheckAlarm();


		}
                //---AutoMode
		else if(bAutoMode && bHomeDone)
		{
			g_DIO.SetDO(DO::StopBtnLamp,false);
			g_DIO.SetDO(DO::StartBtnLamp,true);
			g_DIO.SetDO(DO::GreenLamp,true);
			g_DIO.SetDO(DO::YellowLamp,false);
			g_DIO.SetDO(DO::RedLamp,false);

                        CheckAlarm();
			SetWorkSpeed();

                        //do Auto process
                        DoLaneChanger(nThreadIndex[1]);
                        if(g_IniFile.m_nRailOption==1 || g_IniFile.m_nRailOption==0)
                        {
                                DoLamination(true,nThreadIndex[2]);
                                DoEject(true,nThreadIndex[4]);
                        }
                        if(g_IniFile.m_nRailOption==2 || g_IniFile.m_nRailOption==0)
                        {
                                DoLamination(false,nThreadIndex[3]);
                                DoEject(false,nThreadIndex[5]);
                        }

		}
                //---Manual Mode
		else if(bHomeDone)
		{
			g_DIO.SetDO(DO::StopBtnLamp,true);
			g_DIO.SetDO(DO::StartBtnLamp,false);
                        g_DIO.SetDO(DO::ResetBtnLamp,false);

			SetManualSpeed();

			g_DIO.SetDO(DO::GreenLamp,false);
			g_DIO.SetDO(DO::YellowLamp,true);
			//g_DIO.SetDO(DO::RedLamp,false);

			if(g_DIO.ReadDIBit(DI::StartBtn))
			{
				//nThreadIndex[1]=0;       //some thread need to start from zero

				bAutoMode=true;

                                //g_Motion.AbsMove(AXIS_X,g_Motion.m_dLastTargetPos[AXIS_X]);
                                //g_Motion.AbsMove(AXIS_Y,g_Motion.m_dLastTargetPos[AXIS_Y]);
                                g_Motion.AbsMove(AXIS_LC,g_Motion.m_dLastTargetPos[AXIS_LC]);
                                g_Motion.AbsMove(AXIS_FL,g_Motion.m_dLastTargetPos[AXIS_FL]);
                                g_Motion.AbsMove(AXIS_RL,g_Motion.m_dLastTargetPos[AXIS_RL]);
                                ::Sleep(300);
                                g_Motion.WaitMotionDone(AXIS_X,30000);
                                g_Motion.WaitMotionDone(AXIS_Y,30000);
                                g_Motion.WaitMotionDone(AXIS_LC,30000);
                                g_Motion.WaitMotionDone(AXIS_FL,30000);
                                g_Motion.WaitMotionDone(AXIS_RL,30000);

                                SetWorkSpeed();
			}

                        if(m_bStartPressCal[1]) DoPressCal(true,nThreadIndex[6]);
                        else if(m_bStartPressCal[0]) DoPressCal(false,nThreadIndex[7]);
                        else if(m_bStartLaserUpCal[1]) DoLaserCal(true,true,nThreadIndex[8]);
                        else if(m_bStartLaserUpCal[0]) DoLaserCal(false,true,nThreadIndex[9]);
                        else if(m_bStartLaserDownCal[1]) DoLaserCal(true,false,nThreadIndex[10]);
                        else if(m_bStartLaserDownCal[0]) DoLaserCal(false,false,nThreadIndex[11]);

		}
		else
		{
                        if(!bHomeDone && g_DIO.ReadDIBit(DI::StartBtn)) g_IniFile.m_nErrorCode=29;
                        //Announce to Homing 
			if(tmResetLamp.timeUp())
			{
				g_DIO.SetDO(DO::ResetBtnLamp,bResetLamp);
				g_DIO.SetDO(DO::YellowLamp,bResetLamp);
				bResetLamp=!bResetLamp;
				tmResetLamp.timeStart(500);
			}
		}

                //Non Stop Process when Stop
                if(m_bStartLamSub[1] && bHomeDone) DoLamSub(true,nThreadIndex[13]);
                if(m_bStartLamSub[0] && bHomeDone) DoLamSub(false,nThreadIndex[12]);


		::Sleep(10);
	}
}
//---------------------------------------------------------------------------
bool __fastcall CMainThread::InitialMachine(int &nThreadIndex)
{
        static C_GetTime tm1MS(EX_SCALE::TIME_1MS,false);


        switch(nThreadIndex)
        {
                case 0:
                        g_DIO.WriteDOPort(0,0x00);
                        g_DIO.WriteDOPort(1,0x00);
                        tm1MS.timeStart(300);
                        nThreadIndex++;
                        break;
                case 1:
                        if(tm1MS.timeUp())
                        {
                                g_DIO.SetDO(DO::LCStop,true);
                                g_DIO.SetDO(DO::EjectStop1,true);
                                 g_DIO.SetDO(DO::EjectStop2,true);
                                  g_DIO.SetDO(DO::BigValve1,true);
                                  g_DIO.SetDO(DO::BigValve2,true);
                                 tm1MS.timeStart(3000);
                                nThreadIndex++;
                        }
                        break;
                case 2:
                        if(tm1MS.timeUp())
                        {
                                if(g_DIO.ReadDIBit(DI::LifterVac1) || g_DIO.ReadDIBit(DI::LifterVac2)) g_IniFile.m_nErrorCode=8;
                                //else if(g_DIO.ReadDIBit(DI::LaserCheck)) g_IniFile.m_nErrorCode=9;           //Don't Need
                                else if(!g_DIO.ReadDIBit(DI::LoadCellDown)) g_IniFile.m_nErrorCode=10;
                                //else if(g_DIO.ReadDIBit(DI::LamInp1) || g_DIO.ReadDIBit(DI::LamEntry1) || g_DIO.ReadDIBit(DI::LamWarp1)) g_IniFile.m_nErrorCode=11;     //bypass
                                else if(g_DIO.ReadDIBit(DI::LamInp2) || g_DIO.ReadDIBit(DI::LamEntry2) || g_DIO.ReadDIBit(DI::LamWarp2)) g_IniFile.m_nErrorCode=12;
                                else if(!g_DIO.ReadDIBit(DI::EjectStopUp1)) g_IniFile.m_nErrorCode=13;
                                else if(!g_DIO.ReadDIBit(DI::EjectStopUp2)) g_IniFile.m_nErrorCode=14;
                                else if(g_DIO.ReadDIBit(DI::EjectEntry1) || g_DIO.ReadDIBit(DI::EjectExit1) ||g_DIO.ReadDIBit(DI::EjectInp1) || g_DIO.ReadDIBit(DI::EjectExist1)) g_IniFile.m_nErrorCode=15;
                                else if(g_DIO.ReadDIBit(DI::EjectEntry2) || g_DIO.ReadDIBit(DI::EjectExit2) ||g_DIO.ReadDIBit(DI::EjectInp2) || g_DIO.ReadDIBit(DI::EjectExist2)) g_IniFile.m_nErrorCode=16;
                                else if(!g_DIO.ReadDIBit(DI::LCStopUp)) g_IniFile.m_nErrorCode=17;
                                else if(g_DIO.ReadDIBit(DI::LCInp) || g_DIO.ReadDIBit(DI::LCExist) ||g_DIO.ReadDIBit(DI::LCEntry)) g_IniFile.m_nErrorCode=18;
                                else if(!g_DIO.ReadDIBit(DI::YAxisSafePosA) || !g_DIO.ReadDIBit(DI::YAxisSafePosB)) g_IniFile.m_nErrorCode=51;
                                else nThreadIndex++;
                        }
                        break;
                case 3:
                        if(!g_DIO.ReadDIBit(DI::MainAir)) g_IniFile.m_nErrorCode=6;     //debug
                        else
                        {
                                g_Motion.ServoOn(AXIS_X,true);
                                g_Motion.ServoOn(AXIS_Y,true);
                                g_Motion.ServoOn(AXIS_LC,true);
                                g_Motion.ServoOn(AXIS_FL,true);
                                g_Motion.ServoOn(AXIS_RL,true);
                                nThreadIndex++;
                        }
                        break;
                case 4:
                        g_IniFile.m_nErrorCode=1000;    //Start Homing
                        g_Motion.SetSpeed(AXIS_X,0.01,0.01,20);
                        g_Motion.SetSpeed(AXIS_Y,0.01,0.01,20);
                        g_Motion.SetSpeed(AXIS_LC,0.01,0.01,20);
                        g_Motion.SetSpeed(AXIS_FL,0.01,0.01,5);
                        g_Motion.SetSpeed(AXIS_RL,0.01,0.01,5);

                        if(g_Motion.GetStatus(AXIS_X,PCIM114::MEL) || g_Motion.GetStatus(AXIS_X,PCIM114::ORG)) g_Motion.RelMove(AXIS_X,10.0);
                        if(g_Motion.GetStatus(AXIS_Y,PCIM114::MEL) || g_Motion.GetStatus(AXIS_Y,PCIM114::ORG))g_Motion.RelMove(AXIS_Y,10.0);
                        if(g_Motion.GetStatus(AXIS_LC,PCIM114::MEL) || g_Motion.GetStatus(AXIS_LC,PCIM114::ORG))g_Motion.RelMove(AXIS_LC,10.0);
                        if(g_Motion.GetStatus(AXIS_FL,PCIM114::MEL) || g_Motion.GetStatus(AXIS_FL,PCIM114::ORG))g_Motion.RelMove(AXIS_FL,10.0);
                        if(g_Motion.GetStatus(AXIS_RL,PCIM114::MEL) || g_Motion.GetStatus(AXIS_RL,PCIM114::ORG))g_Motion.RelMove(AXIS_RL,10.0);
                        tm1MS.timeStart(30000);
                        nThreadIndex++;
                        break;
                case 5:
                        if(g_Motion.IsMotionDone(AXIS_X) && g_Motion.IsMotionDone(AXIS_Y) && g_Motion.IsMotionDone(AXIS_LC)&& g_Motion.IsMotionDone(AXIS_FL)&& g_Motion.IsMotionDone(AXIS_RL))
                        {
                                g_Motion.AxisHome(AXIS_LC);
                                g_Motion.AxisHome(AXIS_FL);
                                g_Motion.AxisHome(AXIS_RL);

                                tm1MS.timeStart(1000*30);               //30sec
                                nThreadIndex++;
                        }
                        else if(tm1MS.timeUp()) g_IniFile.m_nErrorCode=20;
                        break;
                case 6:
                        if(/*g_Motion.IsMotionDone(AXIS_LC)&&*/ g_Motion.IsMotionDone(AXIS_FL)&& g_Motion.IsMotionDone(AXIS_RL))
                        {
                                g_Motion.AxisHome(AXIS_X);
                                g_Motion.AxisHome(AXIS_Y);

                                tm1MS.timeStart(1000*30);               //30sec
                                nThreadIndex++;
                        }
                        else if(tm1MS.timeUp()) g_IniFile.m_nErrorCode=21;
                        break;
                case 7:
                        if(g_Motion.IsMotionDone(AXIS_X) && g_Motion.IsMotionDone(AXIS_Y) && g_Motion.IsMotionDone(AXIS_LC))
                        {
                                tm1MS.timeStart(1000);               
                                nThreadIndex++;
                        }
                        else if(tm1MS.timeUp()) g_IniFile.m_nErrorCode=22;
                        break;


                case 8:
                        if(tm1MS.timeUp())
                        {
                                g_Motion.SetSpeed(AXIS_X,g_IniFile.m_dACCSpeed[AXIS_X],g_IniFile.m_dDECSpeed[AXIS_X],g_IniFile.m_dJogSpeed[AXIS_X]);
                                g_Motion.SetSpeed(AXIS_Y,g_IniFile.m_dACCSpeed[AXIS_Y],g_IniFile.m_dDECSpeed[AXIS_Y],g_IniFile.m_dJogSpeed[AXIS_Y]);
                                g_Motion.SetSpeed(AXIS_LC,g_IniFile.m_dACCSpeed[AXIS_LC],g_IniFile.m_dDECSpeed[AXIS_LC],g_IniFile.m_dJogSpeed[AXIS_LC]);
                                g_Motion.SetSpeed(AXIS_FL,g_IniFile.m_dACCSpeed[AXIS_FL],g_IniFile.m_dDECSpeed[AXIS_FL],g_IniFile.m_dJogSpeed[AXIS_FL]);
                                g_Motion.SetSpeed(AXIS_RL,g_IniFile.m_dACCSpeed[AXIS_RL],g_IniFile.m_dDECSpeed[AXIS_RL],g_IniFile.m_dJogSpeed[AXIS_RL]);

                                g_Motion.SetActualPos(AXIS_X,0.0);
                                g_Motion.SetCommandPos(AXIS_X,0.0);
                                g_Motion.SetActualPos(AXIS_Y,0.0);
                                g_Motion.SetCommandPos(AXIS_Y,0.0);
                                g_Motion.SetActualPos(AXIS_LC,0.0);
                                g_Motion.SetCommandPos(AXIS_LC,0.0);
                                g_Motion.SetActualPos(AXIS_FL,0.0);
                                g_Motion.SetCommandPos(AXIS_FL,0.0);
                                g_Motion.SetActualPos(AXIS_RL,0.0);
                                g_Motion.SetCommandPos(AXIS_RL,0.0);

                                g_Motion.m_dLastTargetPos[0]=0.0;
                                g_Motion.m_dLastTargetPos[1]=0.0;
                                g_Motion.m_dLastTargetPos[2]=0.0;
                                g_Motion.m_dLastTargetPos[3]=0.0;
                                g_Motion.m_dLastTargetPos[4]=0.0;
                                g_Motion.m_dLastTargetPos[5]=0.0;
                                g_Motion.m_dLastTargetPos[6]=0.0;
                                g_Motion.m_dLastTargetPos[7]=0.0;

                                // to default position
                                g_Motion.AbsMove(AXIS_Y,g_IniFile.m_dSafePos);

                                nThreadIndex++;
                        }
                        break;
                case 9:
                        if(g_Motion.IsLastPosDone(AXIS_Y))
                        {
                                nThreadIndex++;
                        }
                        break;
                case 10:
                        if(g_Motion.IsMotionDone(AXIS_X) && g_Motion.IsMotionDone(AXIS_Y) && g_Motion.IsMotionDone(AXIS_LC)&& g_Motion.IsMotionDone(AXIS_FL)&& g_Motion.IsMotionDone(AXIS_RL))
                        {
                                g_IniFile.m_nErrorCode=1001;

                                //HANDSHAKE INIT
                                m_bLamReady[0]=false;
                                m_bLamReady[1]=false;
                                m_bEjectReady[0]=false;
                                m_bEjectReady[1]=false;

                                m_bStartPressCal[0]=false;
                                m_bStartPressCal[1]=false;
                                m_bStartLaserUpCal[0]=false;
                                m_bStartLaserUpCal[1]=false;
                                m_bStartLaserDownCal[0]=false;
                                m_bStartLaserDownCal[1]=false;

                                m_bStartLamSub[0]=false;
                                m_bStartLamSub[1]=false;

                                m_dLamTimer[0]=0;
                                m_dLamTimer[1]=0;

                                nThreadIndex++;
                         }
                        break;
                default:
                        nThreadIndex=0;
                        return true;

        }

        if(g_IniFile.m_nErrorCode>0 && g_IniFile.m_nErrorCode<1000)  nThreadIndex=0;

        return false;

}
//---------------------------------------------------------------------------
void __fastcall CMainThread::CheckAlarm()
{
        if(g_Motion.GetStatus(AXIS_X,PCIM114::ALM)) g_IniFile.m_nErrorCode=1;
        if(g_Motion.GetStatus(AXIS_Y,PCIM114::ALM)) g_IniFile.m_nErrorCode=2;
        if(g_Motion.GetStatus(AXIS_LC,PCIM114::ALM)) g_IniFile.m_nErrorCode=3;
        if(g_Motion.GetStatus(AXIS_FL,PCIM114::ALM)) g_IniFile.m_nErrorCode=4;
        if(g_Motion.GetStatus(AXIS_RL,PCIM114::ALM)) g_IniFile.m_nErrorCode=7;

        //if(!g_DIO.ReadDIBit(DI::EmgBtn)) g_IniFile.m_nErrorCode=5;     //debug
        if(!g_DIO.ReadDIBit(DI::MainAir)) g_IniFile.m_nErrorCode=6;  //debug
        if(!g_DIO.ReadDIBit(DI::SafetyDoor) && !g_DIO.ReadDOBit(DO::SafetyDoorByPass) ) g_IniFile.m_nErrorCode=35; //debug
}
//---------------------------------------------------------------------------
void __fastcall CMainThread::SetWorkSpeed()
{
        for(int nIndex=0;nIndex<8;nIndex++)
                g_Motion.SetSpeed(nIndex,g_IniFile.m_dACCSpeed[nIndex],g_IniFile.m_dDECSpeed[nIndex],g_IniFile.m_dWorkSpeed[nIndex]);

}
//---------------------------------------------------------------------------
void __fastcall CMainThread::SetManualSpeed()
{
         for(int nIndex=0;nIndex<8;nIndex++)
                g_Motion.SetSpeed(nIndex,g_IniFile.m_dACCSpeed[nIndex],g_IniFile.m_dDECSpeed[nIndex],g_IniFile.m_dJogSpeed[nIndex]);
}
//---------------------------------------------------------------------------
void __fastcall CMainThread::DoLaneChanger(int &nThreadIndex)
{
        static C_GetTime tm1MS(EX_SCALE::TIME_1MS,false);


        switch(nThreadIndex)
        {
        case 0:
                if(g_DIO.ReadDIBit(DI::LCEntry) ) g_IniFile.m_nErrorCode=40;
                else if(g_DIO.ReadDIBit(DI::LamEntry1)) g_IniFile.m_nErrorCode=41;
                else if(g_DIO.ReadDIBit(DI::LamEntry2)) g_IniFile.m_nErrorCode=42;
                else if(!g_DIO.ReadDIBit(DI::LCStopUp)) g_IniFile.m_nErrorCode=17;
                else
                {
                        g_Motion.AbsMove(AXIS_LC,g_IniFile.m_dLCEntryPos);

                        nThreadIndex++;
                }
                break;
        case 1:
                if(g_Motion.IsLastPosDone(AXIS_LC))
                {
                        g_DIO.SetDO(DO::ReadyIn1,true);
                        nThreadIndex++;
                }
                break;
        case 2:
                if(g_DIO.ReadDIBit(DI::LCEntry))
                {
                        g_DIO.SetDO(DO::ReadyIn1,false);
                        g_DIO.SetDO(DO::LCMotorStart,true);
                        tm1MS.timeStart(5000);
                        nThreadIndex++;
                }
                break;
        case 3:
                g_DIO.SetDO(DO::LCMotorStart,true);     //for alarm->restart
                if(g_DIO.ReadDIBit(DI::LCInp) && g_DIO.ReadDIBit(DI::LCExist))
                {
                        tm1MS.timeStart(300);
                        nThreadIndex++;
                }
                else if(tm1MS.timeUp()) g_IniFile.m_nErrorCode=43;
                break;
        case 4:
                if(tm1MS.timeUp())
                {
                        g_DIO.SetDO(DO::LCMotorStart,false);
                        nThreadIndex++;
                }
                break;
        case 5:
                if(m_bLamReady[0] || m_bLamReady[1])
                {
                        if(m_bLamReady[1]) g_Motion.AbsMove(AXIS_LC,g_IniFile.m_dLCFrontPos);
                        else if(m_bLamReady[0]) g_Motion.AbsMove(AXIS_LC,g_IniFile.m_dLCRearPos);
                        nThreadIndex++;
                }
                break;
        case 6:
                if(g_Motion.IsLastPosDone(AXIS_LC))
                {
                        g_DIO.SetDO(DO::LCStop,false);
                        tm1MS.timeStart(3000);
                        nThreadIndex++;
                }
                break;
        case 7:
                if(g_DIO.ReadDIBit(DI::LCStopDown))
                {
                        g_DIO.SetDO(DO::LCMotorStart,true);
                        tm1MS.timeStart(5000);
                        nThreadIndex++;
                }
                else if(tm1MS.timeUp()) g_IniFile.m_nErrorCode=68;
                break;
        case 8:
                if(!g_DIO.ReadDIBit(DI::LCInp) && !g_DIO.ReadDIBit(DI::LamEntry1) && !g_DIO.ReadDIBit(DI::LamEntry2))
                {
                        tm1MS.timeStart(1000);
                        nThreadIndex++;
                }
                else if(tm1MS.timeUp()) g_IniFile.m_nErrorCode=44;
                break;
        case 9:
                if(tm1MS.timeUp())
                {
                        g_DIO.SetDO(DO::LCMotorStart,false);
                        g_DIO.SetDO(DO::LCStop,true);
                        tm1MS.timeStart(1000);
                        nThreadIndex++;
                }
                break;
        case 10:
                if(g_DIO.ReadDIBit(DI::LCStopUp))
                {
                        nThreadIndex++;
                }
                else if(tm1MS.timeUp()) g_IniFile.m_nErrorCode=17;
                break;
        default:
                nThreadIndex=0;
        }

        //if(g_IniFile.m_nErrorCode>0 && g_IniFile.m_nErrorCode<1000)  nThreadIndex=0;
}
//---------------------------------------------------------------------------
void __fastcall CMainThread::DoLamination(bool bFront,int &nThreadIndex)
{
        static C_GetTime tm1MSFront(EX_SCALE::TIME_1MS,false);
        static C_GetTime tm1MSRear(EX_SCALE::TIME_1MS,false);

        C_GetTime *tm1MS;

        int nLamInp,nLamEntry,nLamWarp,nEjectEntry,nLifterVacGauge,nEjectInp;
        int nLamMotorStart,nLifterVac;
        int nAxisLifter;

        if(bFront)
        {
                nLamInp=DI::LamInp1;
                nLamEntry=DI::LamEntry1;
                nLamWarp=DI::LamWarp1;
                nEjectEntry=DI::EjectEntry1;
                nAxisLifter=AXIS_FL;
                nLifterVacGauge=DI::LifterVac1;
                nEjectInp=DI::EjectInp1;

                nLamMotorStart=DO::LamMotorStart1;
                nLifterVac=DO::LifterVac1;

                tm1MS=&tm1MSFront;


        }
        else
        {
                nLamInp=DI::LamInp2;
                nLamEntry=DI::LamEntry2;
                nLamWarp=DI::LamWarp2;
                nEjectEntry=DI::EjectEntry2;
                nAxisLifter=AXIS_RL;
                nLifterVacGauge=DI::LifterVac2;
                nEjectInp=DI::EjectInp2;

                nLamMotorStart=DO::LamMotorStart2;
                nLifterVac=DO::LifterVac2;

                tm1MS=&tm1MSRear;
        }



        switch(nThreadIndex)
        {
        case 0:
                if(g_DIO.ReadDIBit(nLamEntry)) bFront ? g_IniFile.m_nErrorCode=41: g_IniFile.m_nErrorCode=42;
                else if(g_DIO.ReadDIBit(nLamInp)) bFront ? g_IniFile.m_nErrorCode=45: g_IniFile.m_nErrorCode=46;
                else if(g_DIO.ReadDIBit(nLamWarp)) bFront ? g_IniFile.m_nErrorCode=47: g_IniFile.m_nErrorCode=48;
                else if(g_DIO.ReadDIBit(nEjectEntry)) bFront ? g_IniFile.m_nErrorCode=49: g_IniFile.m_nErrorCode=50;
                else if(!g_DIO.ReadDIBit(DI::YAxisSafePosA) || !g_DIO.ReadDIBit(DI::YAxisSafePosB)) g_IniFile.m_nErrorCode=51;
                else
                {
                        g_Motion.AbsMove(nAxisLifter,g_IniFile.m_dLamStop[bFront]);
                        nThreadIndex++;
                }
                break;
        case 1:
                if(g_Motion.IsLastPosDone(nAxisLifter))
                {
                        m_bLamReady[bFront]=true;
                        nThreadIndex++;
                }
                break;
        case 2:
                if(g_DIO.ReadDIBit(nLamEntry))
                {
                        g_DIO.SetDO(nLamMotorStart,true);
                        m_bLamReady[bFront]=false;
                        tm1MS->timeStart(3000);
                        nThreadIndex++;
                }
                break;
        case 3:
                g_DIO.SetDO(nLamMotorStart,true);
                if(g_DIO.ReadDIBit(nLamInp))
                {
                        tm1MS->timeStart(300);
                        nThreadIndex++;
                }
                else if(g_DIO.ReadDIBit(nLamWarp)) bFront ? g_IniFile.m_nErrorCode=47: g_IniFile.m_nErrorCode=48;
                else if(tm1MS->timeUp())  bFront ? g_IniFile.m_nErrorCode=52: g_IniFile.m_nErrorCode=53;
                break;
        case 4:
                if(tm1MS->timeUp())
                {
                        g_DIO.SetDO(nLamMotorStart,false);
                        m_bStartLamSub[bFront]=!g_IniFile.m_bNotLam;

                        nThreadIndex++;
                }
                break;
        case 5:
                if(!m_bStartLamSub[bFront])
                {
                        tm1MS->timeStart(300);
                        nThreadIndex++;
                }
                break;
       case 6:
                if(tm1MS->timeUp())
                {
                        g_Motion.AbsMove(nAxisLifter,0.0);
                        nThreadIndex++;
                }
                break;

        case 7:
                if(g_Motion.IsLastPosDone(nAxisLifter))
                {
                        nThreadIndex++;
                }
                break;
        case 8:
                if(m_bEjectReady[bFront])
                {
                        g_DIO.SetDO(nLamMotorStart,true);
                        tm1MS->timeStart(5000);
                        nThreadIndex++;
                }
                break;
        case 9:
                if(g_DIO.ReadDIBit(nEjectInp))
                {
                        g_DIO.SetDO(nLamMotorStart,false);
                        nThreadIndex++;
                }
                else if(tm1MS->timeUp())  bFront ? g_IniFile.m_nErrorCode=56: g_IniFile.m_nErrorCode=57;
                break;
        default:
                nThreadIndex=0;
        }
}
//---------------------------------------------------------------------------
void __fastcall CMainThread::DoLamSub(bool bFront,int &nThreadIndex)
{
        static C_GetTime tm1MSFront(EX_SCALE::TIME_1MS,false);
        static C_GetTime tm1MSRear(EX_SCALE::TIME_1MS,false);

        C_GetTime *tm1MS;

        int nLamInp,nLamEntry,nLamWarp,nEjectEntry,nLifterVacGauge,nEjectInp;
        int nLamMotorStart,nLifterVac;
        int nAxisLifter;

        if(bFront)
        {
                nLamInp=DI::LamInp1;
                nLamEntry=DI::LamEntry1;
                nLamWarp=DI::LamWarp1;
                nEjectEntry=DI::EjectEntry1;
                nAxisLifter=AXIS_FL;
                nLifterVacGauge=DI::LifterVac1;
                nEjectInp=DI::EjectInp1;

                nLamMotorStart=DO::LamMotorStart1;
                nLifterVac=DO::LifterVac1;

                tm1MS=&tm1MSFront;


        }
        else
        {
                nLamInp=DI::LamInp2;
                nLamEntry=DI::LamEntry2;
                nLamWarp=DI::LamWarp2;
                nEjectEntry=DI::EjectEntry2;
                nAxisLifter=AXIS_RL;
                nLifterVacGauge=DI::LifterVac2;
                nEjectInp=DI::EjectInp2;

                nLamMotorStart=DO::LamMotorStart2;
                nLifterVac=DO::LifterVac2;

                tm1MS=&tm1MSRear;
        }



        switch(nThreadIndex)
        {
        case 0:
                //if(tm1MS->timeUp())
                {
                        g_DIO.SetDO(nLamMotorStart,false);
                        g_Motion.AbsMove(nAxisLifter,g_IniFile.m_dLamVacHeight[bFront]);
                        
                        nThreadIndex++;
                }
                break;
        case 1:
                if(g_Motion.IsLastPosDone(nAxisLifter))
                {
                        g_DIO.SetDO(nLifterVac,true);
                        tm1MS->timeStart(3000);
                         nThreadIndex++;
                }
                break;
        case 2:
                if(/*g_DIO.ReadDIBit(nLifterVac)*/true)    //bypass
                {
                        tm1MS->timeStart(300);
                         nThreadIndex++;
                }
                else if(tm1MS->timeUp())  bFront ? g_IniFile.m_nErrorCode=54: g_IniFile.m_nErrorCode=55;
                break;
        case 3:
                if(tm1MS->timeUp())
                {
                        g_Motion.SetSpeed(nAxisLifter,0.1,3.0,g_IniFile.m_dWorkSpeed[nAxisLifter]);
                        g_Motion.AbsMove(nAxisLifter,g_IniFile.m_dLamHeight[bFront]);
                        nThreadIndex++;
                }
                break;
        case 4:
                if(g_Motion.IsLastPosDone(nAxisLifter))
                {
                        g_Motion.SetSpeed(nAxisLifter,g_IniFile.m_dACCSpeed[nAxisLifter],g_IniFile.m_dDECSpeed[nAxisLifter] ,g_IniFile.m_dWorkSpeed[nAxisLifter]);
                        tm1MS->timeStart(g_IniFile.m_dLamTime[bFront]*1000);
                        
                        nThreadIndex++;
                }
                break;
        case 5:
                if(tm1MS->timeUp())
                {
                        g_Motion.AbsMove(nAxisLifter,g_IniFile.m_dLamVacHeight[bFront]);
                        m_dLamTimer[bFront]=0;
                        nThreadIndex++;
                }
                m_dLamTimer[bFront]=g_IniFile.m_dLamTime[bFront]*1000-tm1MS->timeStartTime();
                break;
        case 6:
                if(g_Motion.IsLastPosDone(nAxisLifter))
                {
                        g_DIO.SetDO(nLifterVac,false);
                        tm1MS->timeStart(500);
                        nThreadIndex++;
                }
                break;
        default:
                m_bStartLamSub[bFront]=false;
                nThreadIndex=0;
        }
}
//---------------------------------------------------------------------------
void __fastcall CMainThread::DoEject(bool bFront,int &nThreadIndex)
{
        static C_GetTime tm1MSFront(EX_SCALE::TIME_1MS,false);
        static C_GetTime tm1MSRear(EX_SCALE::TIME_1MS,false);

        C_GetTime *tm1MS;

        int nEjectInp,nEjectEntry,nEjectExit,nEjectExist,nEjectStopUp,nEjectStopDown,nReadyOut;
        int nEjectMotorStart,nEjectStop;

        if(bFront)
        {
                nEjectInp=DI::EjectInp1;
                nEjectEntry=DI::EjectEntry1;
                nEjectExit=DI::EjectExit1;
                nEjectExist=DI::EjectExist1;
                nEjectStopUp=DI::EjectStopUp1;
                nEjectStopDown=DI::EjectStopDown1;
                nReadyOut=DI::ReadyOut1;

                nEjectMotorStart=DO::EjectMotorStart1;
                nEjectStop=DO::EjectStop1;

                tm1MS=&tm1MSFront;
        }
        else
        {
                nEjectInp=DI::EjectInp2;
                nEjectEntry=DI::EjectEntry2;
                nEjectExit=DI::EjectExit2;
                nEjectExist=DI::EjectExist2;
                nEjectStopUp=DI::EjectStopUp2;
                nEjectStopDown=DI::EjectStopDown2;
                nReadyOut=DI::ReadyOut2;

                nEjectMotorStart=DO::EjectMotorStart2;
                nEjectStop=DO::EjectStop2;

                tm1MS=&tm1MSRear;
        }


        switch(nThreadIndex)
        {
        case 0:
                if(g_DIO.ReadDIBit(nEjectInp) ) bFront ? g_IniFile.m_nErrorCode=59: g_IniFile.m_nErrorCode=58;
                else if(g_DIO.ReadDIBit(nEjectEntry)) bFront ? g_IniFile.m_nErrorCode=61: g_IniFile.m_nErrorCode=60;
                else if(g_DIO.ReadDIBit(nEjectExit)) bFront ? g_IniFile.m_nErrorCode=63: g_IniFile.m_nErrorCode=62;
                else if(g_DIO.ReadDIBit(nEjectExist)) bFront ? g_IniFile.m_nErrorCode=65: g_IniFile.m_nErrorCode=64;
                else if(!g_DIO.ReadDIBit(nEjectStopUp)) bFront ? g_IniFile.m_nErrorCode=13: g_IniFile.m_nErrorCode=14;
                else
                {
                        m_bEjectReady[bFront]=true;
                        nThreadIndex++;
                }
                break;
        case 1:
                if(g_DIO.ReadDIBit(nEjectEntry))
                {
                        m_bEjectReady[bFront]=false;
                        g_DIO.SetDO(nEjectMotorStart,true);
                        tm1MS->timeStart(5000);
                        nThreadIndex++;
                }
                break;
        case 2:
                if(g_DIO.ReadDIBit(nEjectInp) && g_DIO.ReadDIBit(nEjectExist))
                {
                        tm1MS->timeStart(500);
                        nThreadIndex++;
                }
                else if(tm1MS->timeUp()) bFront ? g_IniFile.m_nErrorCode=56: g_IniFile.m_nErrorCode=57;
                break;
        case 3:
                if(tm1MS->timeUp())
                {
                        g_DIO.SetDO(nEjectMotorStart,false);
                        nThreadIndex++;
                }
                break;
        case 4:
                if(/*g_DIO.ReadDIBit(nReadyOut)*/true)        //bypass
                {
                        g_DIO.SetDO(nEjectStop,false);
                        tm1MS->timeStart(3000);
                        nThreadIndex++;
                }
                break;
        case 5:
                if(g_DIO.ReadDIBit(nEjectStopDown))
                {
                        g_DIO.SetDO(nEjectMotorStart,true);
                        tm1MS->timeStart(10000);
                        nThreadIndex++;
                }
                else if(tm1MS->timeUp()) bFront ? g_IniFile.m_nErrorCode=67: g_IniFile.m_nErrorCode=66;
                break;
        case 6:
                if(!g_DIO.ReadDIBit(nEjectInp) && !g_DIO.ReadDIBit(nEjectEntry) && !g_DIO.ReadDIBit(nEjectExit) && !g_DIO.ReadDIBit(nEjectExist))
                {
                        g_DIO.SetDO(nEjectMotorStart,false);
                        g_DIO.SetDO(nEjectStop,true);
                        tm1MS->timeStart(3000);
                        nThreadIndex++;

                }
                else if(tm1MS->timeUp()) bFront ? g_IniFile.m_nErrorCode=67: g_IniFile.m_nErrorCode=66;
                break;
        case 7:
                if(g_DIO.ReadDIBit(nEjectStopUp))
                {
                        nThreadIndex++;
                }
                else if(tm1MS->timeUp()) bFront ? g_IniFile.m_nErrorCode=13: g_IniFile.m_nErrorCode=14;
                break; 
        default:
                nThreadIndex=0;
        }
}
//---------------------------------------------------------------------------
void __fastcall CMainThread::DoPressCal(bool bFront,int &nThreadIndex)
{
        static C_GetTime tm1MS(EX_SCALE::TIME_1MS,false);

        const int nTagA=1000;

        double dStartX,dStartY;
        CPISODNM100 *pDNPort;

        static int nMoveIndex=0;
        static int nTryTimes=0;

        if(bFront)
        {


                dStartX=g_IniFile.m_dLoadCellPosX[0];
                dStartY=g_IniFile.m_dLoadCellPosY[0];

                pDNPort=&g_DNPort0;
        }
        else
        {


                dStartX=g_IniFile.m_dLoadCellPosX[1];
                dStartY=g_IniFile.m_dLoadCellPosY[1];

                pDNPort=&g_DNPort1;
        }

        switch(nThreadIndex)
        {
        case 0:
                if(g_Motion.GetActualPos(AXIS_FL)>g_IniFile.m_dLamStop[0] || g_Motion.GetActualPos(AXIS_RL)> g_IniFile.m_dLamStop[1]) g_IniFile.m_nErrorCode=69;
                else if(!g_DIO.ReadDIBit(DI::LoadCellDown)) g_IniFile.m_nErrorCode=10;
                //else if(g_DIO.ReadDIBit(DI::LaserCheck)) g_IniFile.m_nErrorCode=9;    //don't need
                {
                        m_nCalCol=nMoveIndex % 10;
                        m_nCalRow=nMoveIndex /  10;

                        if(m_nCalCol<g_IniFile.m_nCols && m_nCalRow< g_IniFile.m_nRows)
                        {
                                nTryTimes=0;
                                m_listLog.push_back("開始重量校正程序-->"+FormatFloat("0",nMoveIndex+1));

                                g_Motion.AbsMove(AXIS_X,dStartX+m_nCalCol*g_IniFile.m_dColPitch);
                                g_Motion.AbsMove(AXIS_Y,dStartY-m_nCalRow*g_IniFile.m_dRowPitch);
                                nThreadIndex++;
                        }else nThreadIndex=nTagA;
                }
                break;
        case 1:
                if(g_Motion.IsPosDone(AXIS_X,dStartX+m_nCalCol*g_IniFile.m_dColPitch) && g_Motion.IsPosDone(AXIS_Y,dStartY-m_nCalRow*g_IniFile.m_dRowPitch))
                {
                        if(g_DIO.ReadDIBit(DI::LaserCheck)) g_IniFile.m_nErrorCode=9;
                        else
                        {
                                g_DIO.SetDO(DO::LoadCellValve,true);
                                tm1MS.timeStart(3000);
                                nThreadIndex++;
                        }
                }
                break;
        case 2:
                if(g_DIO.ReadDIBit(DI::LoadCellUp))
                {
                        tm1MS.timeStart(1000);          //Laser Stable Time
                        nThreadIndex++;
                }
                else if(tm1MS.timeUp()) g_IniFile.m_nErrorCode=70;
                break;
        case 3:
                if(tm1MS.timeUp())
                {
                        //Get Load Cell Value
                        double dLoadCellValue=g_Balance.GetKg(1);       //Kg
                        m_listLog.push_back("重量="+FormatFloat("0.00 Kg",dLoadCellValue));
                        if(dLoadCellValue > g_IniFile.m_dLamPress[bFront]*1.1 ||  dLoadCellValue < g_IniFile.m_dLamPress[bFront]*0.9)
                        {
                                m_listLog.push_back("OK");
                                nThreadIndex=nTagA;
                        }
                        else
                        {
                                m_listLog.push_back("NG-->Try Again");
                                double dNewValue=g_IniFile.m_dLamPress[bFront]*g_IniFile.m_dLamPress[bFront]/dLoadCellValue;            //
                                m_listLog.push_back("Set Data="+FormatFloat("0.00 Kg/cm2",dNewValue));
                                pDNPort->SetKg(nMoveIndex,dNewValue);
                                pDNPort->WriteAllData();
                                
                                nTryTimes++;
                                if(nTryTimes<3)
                                {
                                        tm1MS.timeStart(3000);     //valve stable time 
                                }
                                else g_IniFile.m_nErrorCode=71;
                        }
                }
                break;
        case 4:
        case nTagA: nThreadIndex=4;
                {
                        g_DIO.SetDO(DO::LoadCellValve,false);
                        tm1MS.timeStart(3000);
                        nThreadIndex++;
                }
                break;
        case 5:
                if(g_DIO.ReadDIBit(DI::LoadCellDown))
                {
                         nMoveIndex++;
                        if(nMoveIndex<50) nThreadIndex++;
                        else
                        {
                                nMoveIndex=0;
                                //Write Set Value to Inifile;
                                g_IniFile.m_nErrorCode=72;
                        }
                }
                else if(tm1MS.timeUp()) g_IniFile.m_nErrorCode=10;
                break;
        default:
               nThreadIndex=0;
        }

        if(g_IniFile.m_nErrorCode>0 && g_IniFile.m_nErrorCode<1000)
        {
                nMoveIndex=0;
                nThreadIndex=0;
        }
}
//---------------------------------------------------------------------------
void __fastcall CMainThread::DoLaserCal(bool bFront,bool bUp,int &nThreadIndex)
{
        static C_GetTime tm1MS(EX_SCALE::TIME_1MS,false);

        const int nTagA=1000;


        double dStartX,dStartY;
        int nLaserChannel;
        double *p_dLaserValue;


        static int nMoveIndex=0;

        if(bFront)
        {

                if(bUp)
                {
                        dStartX=g_IniFile.m_dLaserUpPosX[0];
                        dStartY=g_IniFile.m_dLaserUpPosY[0];
                        nLaserChannel=0;

                        p_dLaserValue=m_dFrontUpperLaser;
                }
                else
                {
                        dStartX=g_IniFile.m_dLaserDownPosX[0];
                        dStartY=g_IniFile.m_dLaserDownPosY[0];
                        nLaserChannel=1;

                        p_dLaserValue=m_dFrontDownLaser;
                }

        }
        else
        {
                if(bUp)
                {
                        dStartX=g_IniFile.m_dLaserUpPosX[1];
                        dStartY=g_IniFile.m_dLaserUpPosY[1];
                        nLaserChannel=0;

                        p_dLaserValue=m_dRearUpperLaser;
                }
                else
                {
                        dStartX=g_IniFile.m_dLaserDownPosX[1];
                        dStartY=g_IniFile.m_dLaserDownPosY[1];
                        nLaserChannel=1;

                        p_dLaserValue=m_dRearDownLaser;
                }


        }

        switch(nThreadIndex)
        {
        case 0:
                if(g_Motion.GetActualPos(AXIS_FL)>g_IniFile.m_dLamStop[0] || g_Motion.GetActualPos(AXIS_RL)> g_IniFile.m_dLamStop[1]) g_IniFile.m_nErrorCode=69;
                else if(!g_DIO.ReadDIBit(DI::LoadCellDown)) g_IniFile.m_nErrorCode=10;
                //else if(g_DIO.ReadDIBit(DI::LaserCheck)) g_IniFile.m_nErrorCode=9;      //don't need
                {
                        m_nCalCol=nMoveIndex % 10;
                        m_nCalRow=nMoveIndex / 10;

                        if(m_nCalCol<g_IniFile.m_nCols && m_nCalRow< g_IniFile.m_nRows)
                        {
                                if(nMoveIndex==0) memset(p_dLaserValue,0,sizeof(double)*50);
                                m_listLog.push_back("開始Laser 量測程序-->"+FormatFloat("0",nMoveIndex));

                                g_Motion.AbsMove(AXIS_X,dStartX+m_nCalCol*g_IniFile.m_dColPitch);
                                g_Motion.AbsMove(AXIS_Y,dStartY-m_nCalRow*g_IniFile.m_dRowPitch);
                                nThreadIndex++;
                        }else nThreadIndex=nTagA;
                }
                break;
        case 1:
                if(g_Motion.IsPosDone(AXIS_X,dStartX+m_nCalCol*g_IniFile.m_dColPitch) && g_Motion.IsPosDone(AXIS_Y,dStartY-m_nCalRow*g_IniFile.m_dRowPitch))
                {
                        if(g_DIO.ReadDIBit(DI::LaserCheck)) g_IniFile.m_nErrorCode=9;
                        else
                        {
                                tm1MS.timeStart(1000);
                                nThreadIndex++;
                        }
                }
                break;
        case 2:
                if(tm1MS.timeUp())
                {
                        double dLaserData=0.0;
                        dLaserData=g_DNPort0.GetMM(51,nLaserChannel);

                        m_listLog.push_back("高度="+FormatFloat("0.00 mm",dLaserData));
                        nThreadIndex++;
                }
                break;
        case 3:
        case nTagA:nThreadIndex=3;
                {
                         nMoveIndex++;
                        if(nMoveIndex<50) nThreadIndex++;
                        else
                        {
                                nMoveIndex=0;
                                g_IniFile.m_nErrorCode=73;
                        }
                }
                break;
        default:
               nThreadIndex=0;
        }

        if(g_IniFile.m_nErrorCode>0 && g_IniFile.m_nErrorCode<1000)
        {
                nMoveIndex=0;
                nThreadIndex=0;
        }
}





